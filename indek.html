<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAKA HYDROCORE - Vessel Offset Diagram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --taka-navy: #1e3a8a;
            --taka-blue: #2563eb;
            --taka-light: #3b82f6;
            --taka-accent: #60a5fa;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        input[type="number"] {
            ime-mode: disabled;
        }
        .vessel-input-wrapper {
            display: none;
        }
        .vessel-input-wrapper.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen p-6">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-xl p-6 mb-6 border-t-4 border-[#1e3a8a]">
            <div class="flex items-center mb-4 gap-6">
                <img src="thi_logo.png" alt="Taka Hydrocore Logo" class="h-16 w-auto">
                <div class="flex-1 text-center">
                    <h1 class="text-3xl font-bold text-[#1e3a8a]">Vessel Offset Data Input</h1>
                    <p class="text-sm text-[#2563eb] mt-1 font-medium">Data Input & Visualization</p>
                </div>
            </div>

            <!-- Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Surveyor:</label>
                    <input type="text" id="surveyor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Enter surveyor name">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Client:</label>
                    <input type="text" id="client" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Enter client name">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Date:</label>
                    <input type="date" id="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Project:</label>
                    <input type="text" id="project" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Enter project name">
                </div>
            </div>
        </div>

        <!-- Vessel Selection -->
        <div class="bg-white rounded-lg shadow-lg hover:shadow-xl p-6 mb-6 transition-shadow duration-300">
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">VESSEL</label>
                <select id="vessel" class="w-full px-4 py-3 border-2 border-[#1a5f7a] rounded-lg text-lg font-semibold focus:ring-2 focus:ring-[#2563eb] focus:border-transparent">
                    <option value="">Select Vessel</option>
                    <option value="ss_barakuda">SS Barakuda</option>
                    <option value="ag_geodrill">AG Geodrill</option>
                    <option value="other">Other Vessel</option>
                </select>
            </div>

            <!-- Vessel Name Input (for Other Vessel) -->
            <div class="vessel-input-wrapper mb-6" id="vesselNameInput">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Vessel Name:</label>
                <input type="text" id="vesselName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Enter vessel name">
            </div>

            <!-- Vessel Dimensions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Vessel Length:</label>
                    <div class="flex gap-2">
                        <input type="number" id="vesselLength" step="0.01" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Enter length">
                        <span class="flex items-center px-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 font-semibold">m</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Vessel Width:</label>
                    <div class="flex gap-2">
                        <input type="number" id="vesselWidth" step="0.01" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Enter width">
                        <span class="flex items-center px-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 font-semibold">m</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sensor Position Table -->
        <div class="bg-white rounded-lg shadow-lg hover:shadow-xl p-6 mb-6 transition-shadow duration-300">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Sensor Position</h2>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-[#1a5f7a] text-white">
                            <th class="border border-gray-300 px-4 py-3 text-left font-semibold">SENSOR</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">X</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Y</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Z</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Reference</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-semibold w-20">Action</th>
                        </tr>
                    </thead>
                    <tbody id="sensorTable">
                    </tbody>
                </table>
            </div>

            <button onclick="addSensor()" class="mt-4 flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add Sensor Row
            </button>
        </div>

        <!-- Results Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ðŸ“Š Results</h2>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Calculate offsets relative to:</label>
                <select id="referenceSelect" onchange="calculateResults()" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2563eb] focus:border-transparent">
                    <option value="">Select Reference Sensor</option>
                </select>
            </div>
            <div id="resultsTable"></div>
        </div>

        <!-- Vessel Visualization -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6" id="vesselVisualization" style="display:none;">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Vessel Diagram</h2>
            <div class="flex gap-2 mb-4">
                <button onclick="zoomIn()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Zoom In
                </button>
                <button onclick="zoomOut()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Zoom Out
                </button>
                <button onclick="resetZoom()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    Reset View
                </button>
            </div>
            <canvas id="vesselCanvas" width="1600" height="1000" class="w-full border border-gray-300 rounded-lg" style="max-height:600px;"></canvas>
        </div>

        <!-- Export Button -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <button onclick="downloadSCR()" class="w-full flex items-center justify-center gap-3 px-6 py-4 bg-[#1a5f7a] text-white rounded-lg hover:bg-[#154d61] transition-colors text-lg font-semibold">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download SCR File
            </button>
            <p class="text-center text-sm text-gray-600 mt-3">
                File SCR (AutoCAD Script) berisi vessel diagram dan sensor positions
            </p>
        </div>
    </div>

    <script>
        let sensorCounter = 0;
        const sensors = [];
        let zoomLevel = 1.0;
        let panOffsetX = 0;
        let panOffsetY = 0;
        let isPanning = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        document.getElementById('date').valueAsDate = new Date();

        document.addEventListener('keydown', function(e) {
            if (e.target.type === 'number' && (e.key === ',' || e.key === 'Decimal')) {
                e.preventDefault();
            }
        });

        document.getElementById('vessel').addEventListener('change', function() {
            const vessel = this.value;
            const lengthInput = document.getElementById('vesselLength');
            const widthInput = document.getElementById('vesselWidth');
            const vesselNameInput = document.getElementById('vesselNameInput');
            const vesselNameField = document.getElementById('vesselName');

            if (vessel === 'other') {
                vesselNameInput.classList.add('active');
                lengthInput.disabled = false;
                widthInput.disabled = false;
                lengthInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                widthInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                lengthInput.value = '';
                widthInput.value = '';
                vesselNameField.value = '';
            } else if (vessel === 'ss_barakuda' || vessel === 'ag_geodrill') {
                vesselNameInput.classList.remove('active');
                lengthInput.disabled = true;
                widthInput.disabled = true;
                lengthInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                widthInput.classList.add('bg-gray-100', 'cursor-not-allowed');

                if (vessel === 'ss_barakuda') {
                    lengthInput.value = '50.00';
                    widthInput.value = '12.00';
                } else {
                    lengthInput.value = '45.00';
                    widthInput.value = '10.00';
                }
            } else {
                vesselNameInput.classList.remove('active');
                lengthInput.disabled = false;
                widthInput.disabled = false;
                lengthInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                widthInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                lengthInput.value = '';
                widthInput.value = '';
            }
            drawVessel();
        });

        document.getElementById('vesselLength').addEventListener('input', drawVessel);
        document.getElementById('vesselWidth').addEventListener('input', drawVessel);

        function initializeSensors() {
            addSensor('CoG');
            addSensor('GPS');
            addSensor('SSS');
        }

        function addSensor(defaultName = '') {
            const id = sensorCounter++;
            sensors.push({ id, name: defaultName, x: '', y: '', z: '', reference: 'CoG' });
            renderSensors();
            updateReferenceDropdowns();
            calculateResults();
        }

        function removeSensor(id) {
            const sensor = sensors.find(s => s.id === id);
            if (sensor && sensor.name === 'CoG') {
                alert('CoG tidak bisa dihapus!');
                return;
            }
            if (sensors.length <= 2) {
                alert('Minimal harus ada 2 sensor!');
                return;
            }
            const index = sensors.findIndex(s => s.id === id);
            if (index > -1) {
                sensors.splice(index, 1);
                renderSensors();
                updateReferenceDropdowns();
                calculateResults();
            }
        }

        function updateSensor(id, field, value) {
            const sensor = sensors.find(s => s.id === id);
            if (sensor) {
                sensor[field] = value;
                if (field === 'name') {
                    updateReferenceDropdowns();
                }
                calculateResults();
                drawVessel();
            }
        }

        function updateReferenceDropdowns() {
            const sensorNames = sensors.map(s => s.name).filter(name => name);

            const resultSelect = document.getElementById('referenceSelect');
            const currentValue = resultSelect.value;
            resultSelect.innerHTML = '<option value="">Select Reference Sensor</option>';
            sensorNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === currentValue) option.selected = true;
                resultSelect.appendChild(option);
            });

            renderSensors();
        }

        function renderSensors() {
            const tbody = document.getElementById('sensorTable');
            tbody.innerHTML = '';

            const sensorNames = sensors.map(s => s.name).filter(name => name);

            sensors.forEach(sensor => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let referenceOptions = '';
                sensorNames.forEach(name => {
                    const selected = sensor.reference === name ? 'selected' : '';
                    referenceOptions += `<option value="${name}" ${selected}>${name}</option>`;
                });

                const isCoG = sensor.name === 'CoG';
                const deleteButton = isCoG ? 
                    '<span class="text-gray-400">-</span>' :
                    `<button onclick="removeSensor(${sensor.id})" class="p-2 rounded hover:bg-red-50 text-red-600" title="Delete sensor">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>`;

                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="text" value="${sensor.name}" onchange="updateSensor(${sensor.id}, 'name', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="Sensor name">
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="number" step="0.001" value="${sensor.x}" onchange="updateSensor(${sensor.id}, 'x', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded text-center focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="">
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="number" step="0.001" value="${sensor.y}" onchange="updateSensor(${sensor.id}, 'y', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded text-center focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="">
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="number" step="0.001" value="${sensor.z}" onchange="updateSensor(${sensor.id}, 'z', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded text-center focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" placeholder="">
                    </td>
                    <td class="border border-gray-300 px-4 py-2">
                        <select onchange="updateSensor(${sensor.id}, 'reference', this.value)" class="w-full px-3 py-2 border border-gray-200 rounded focus:ring-2 focus:ring-[#2563eb] focus:border-transparent" ${isCoG ? 'disabled' : ''}>
                            ${referenceOptions}
                        </select>
                    </td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        ${deleteButton}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateAbsolutePositions() {
            const absolute = {};
            const processed = new Set();

            function processRecursive(name) {
                if (processed.has(name)) return;

                const sensor = sensors.find(s => s.name === name);
                if (!sensor) return;

                const x = parseFloat(sensor.x) || 0;
                const y = parseFloat(sensor.y) || 0;
                const z = parseFloat(sensor.z) || 0;

                if (sensor.reference === name) {
                    absolute[name] = { x, y, z };
                    processed.add(name);
                } else {
                    if (!processed.has(sensor.reference)) {
                        processRecursive(sensor.reference);
                    }
                    const refPos = absolute[sensor.reference];
                    if (refPos) {
                        absolute[name] = {
                            x: refPos.x + x,
                            y: refPos.y + y,
                            z: refPos.z + z
                        };
                        processed.add(name);
                    }
                }
            }

            sensors.forEach(sensor => {
                if (sensor.name && !processed.has(sensor.name)) {
                    processRecursive(sensor.name);
                }
            });

            return absolute;
        }

        function calculateResults() {
            const refSensor = document.getElementById('referenceSelect').value;
            const resultsDiv = document.getElementById('resultsTable');

            if (!refSensor) {
                resultsDiv.innerHTML = '<p class="text-gray-500 text-sm">Pilih sensor referensi untuk melihat hasil perhitungan.</p>';
                return;
            }

            const absolutePositions = calculateAbsolutePositions();
            const refPos = absolutePositions[refSensor];

            if (!refPos) {
                resultsDiv.innerHTML = '<p class="text-red-500 text-sm">Error: Reference sensor tidak ditemukan.</p>';
                return;
            }

            let html = `<p class="text-sm text-gray-600 mb-3">Semua koordinat relatif terhadap: <strong>${refSensor}</strong></p>`;
            html += '<div class="overflow-x-auto"><table class="w-full border-collapse"><thead><tr class="bg-gray-100">';
            html += '<th class="border border-gray-300 px-4 py-2 text-left font-semibold">Sensor</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-center font-semibold">X (m)</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-center font-semibold">Y (m)</th>';
            html += '<th class="border border-gray-300 px-4 py-2 text-center font-semibold">Z (m)</th>';
            html += '</tr></thead><tbody>';

            sensors.forEach(sensor => {
                if (sensor.name && absolutePositions[sensor.name]) {
                    const pos = absolutePositions[sensor.name];
                    const relX = (pos.x - refPos.x).toFixed(3);
                    const relY = (pos.y - refPos.y).toFixed(3);
                    const relZ = (pos.z - refPos.z).toFixed(3);

                    html += `<tr class="hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-2">${sensor.name}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${relX}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${relY}</td>
                        <td class="border border-gray-300 px-4 py-2 text-center">${relZ}</td>
                    </tr>`;
                }
            });

            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
            drawVessel();
        }

        function downloadSCR() {
            const length = parseFloat(document.getElementById('vesselLength').value);
            const width = parseFloat(document.getElementById('vesselWidth').value);
            const project = document.getElementById('project').value;
            const date = document.getElementById('date').value;
            const refSensor = document.getElementById('referenceSelect').value;

            if (!length || !width || length <= 0 || width <= 0) {
                alert('Please enter valid vessel dimensions first.');
                return;
            }

            if (!refSensor) {
                alert('Please select a reference sensor in Results section.');
                return;
            }

            const absolutePositions = calculateAbsolutePositions();
            const refPos = absolutePositions[refSensor];

            if (!refPos) {
                alert('Error: Reference sensor not found.');
                return;
            }

            // Build SCR - PERSIS seperti format contoh
            let scr = '';
            scr += '; TAKA HYDROCORE - Vessel Offset Diagram\n';
            scr += '; Project: ' + (project || 'Untitled') + '\n';
            scr += '; Date: ' + date + '\n';
            scr += '; Reference: ' + refSensor + '\n';

            const bowLength = length * 0.15;
            const sternLength = length * 0.10;
            const startY = length / 2;
            const endY = -length / 2;
            const sternCornerRadius = width * 0.15;

            const points = [];

            for (let y = startY; y >= startY - bowLength; y -= 0.5) {
                const localY = startY - y;
                const ratio = localY / bowLength;
                const x = (width/2) * Math.sqrt(Math.abs(2 * ratio - ratio * ratio));
                points.push(`${x.toFixed(3)},${y.toFixed(3)}`);
            }

            points.push(`${(width/2).toFixed(3)},${(startY - bowLength).toFixed(3)}`);
            points.push(`${(width/2).toFixed(3)},${(endY + sternLength).toFixed(3)}`);

            for (let angle = 0; angle <= 90; angle += 10) {
                const rad = angle * Math.PI / 180;
                const cx = (width/2 - sternCornerRadius);
                const cy = endY + sternCornerRadius;
                const px = cx + sternCornerRadius * Math.cos(rad);
                const py = cy - sternCornerRadius * Math.sin(rad);
                points.push(`${px.toFixed(3)},${py.toFixed(3)}`);
            }

            points.push(`${(width/2 - sternCornerRadius).toFixed(3)},${endY.toFixed(3)}`);
            points.push(`${(-(width/2 - sternCornerRadius)).toFixed(3)},${endY.toFixed(3)}`);

            for (let angle = 90; angle <= 180; angle += 10) {
                const rad = angle * Math.PI / 180;
                const cx = -(width/2 - sternCornerRadius);
                const cy = endY + sternCornerRadius;
                const px = cx + sternCornerRadius * Math.cos(rad);
                const py = cy - sternCornerRadius * Math.sin(rad);
                points.push(`${px.toFixed(3)},${py.toFixed(3)}`);
            }

            points.push(`${(-width/2).toFixed(3)},${(endY + sternLength).toFixed(3)}`);
            points.push(`${(-width/2).toFixed(3)},${(startY - bowLength).toFixed(3)}`);

            for (let y = startY - bowLength; y <= startY; y += 0.5) {
                const localY = startY - y;
                const ratio = localY / bowLength;
                const x = (width/2) * Math.sqrt(Math.abs(2 * ratio - ratio * ratio));
                points.push(`${(-x).toFixed(3)},${y.toFixed(3)}`);
            }

            // PLINE dalam SATU BARIS seperti contoh
            scr += 'PLINE ' + points.join(' ') + ' C\n';

            // CIRCLE setiap sensor - SATU BARIS per circle
            sensors.forEach(sensor => {
                if (sensor.name && absolutePositions[sensor.name]) {
                    const pos = absolutePositions[sensor.name];
                    const relX = pos.x - refPos.x;
                    const relY = pos.y - refPos.y;
                    scr += `CIRCLE ${relX.toFixed(3)},${relY.toFixed(3)} 0.1\n`;
                }
            });

            // TEXT setiap sensor - SATU BARIS per text
            sensors.forEach(sensor => {
                if (sensor.name && absolutePositions[sensor.name]) {
                    const pos = absolutePositions[sensor.name];
                    const relX = pos.x - refPos.x;
                    const relY = pos.y - refPos.y;
                    scr += `TEXT ${(relX + 0.15).toFixed(3)},${(relY + 0.15).toFixed(3)} 0.3 0 ${sensor.name}\n`;
                }
            });

            scr += 'ZOOM E\n';

            const blob = new Blob([scr], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `vessel_offset_${project || 'data'}_${date}.scr`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function zoomIn() {
            zoomLevel *= 1.2;
            drawVessel();
        }

        function zoomOut() {
            zoomLevel /= 1.2;
            drawVessel();
        }

        function resetZoom() {
            zoomLevel = 1.0;
            panOffsetX = 0;
            panOffsetY = 0;
            drawVessel();
        }

        function drawVessel() {
            const length = parseFloat(document.getElementById('vesselLength').value);
            const width = parseFloat(document.getElementById('vesselWidth').value);

            const viz = document.getElementById('vesselVisualization');
            if (!length || !width || length <= 0 || width <= 0) {
                viz.style.display = 'none';
                return;
            }

            viz.style.display = 'block';
            const canvas = document.getElementById('vesselCanvas');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 200;
            const availableWidth = canvas.width - 2 * padding;
            const availableHeight = canvas.height - 2 * padding;
            const baseScale = Math.min(availableWidth / width, availableHeight / length) * 0.8;
            const scale = baseScale * zoomLevel;

            const centerX = canvas.width / 2 + panOffsetX;
            const centerY = canvas.height / 2 + panOffsetY;

            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;

            let gridSpacing = 1;
            if (zoomLevel > 2) gridSpacing = 0.1;
            else if (zoomLevel > 1.5) gridSpacing = 0.5;

            const gridExtent = Math.max(length, width) * 0.7;

            for (let x = -gridExtent; x <= gridExtent; x += gridSpacing) {
                const screenX = centerX + x * scale;
                if (screenX >= 0 && screenX <= canvas.width) {
                    ctx.beginPath();
                    ctx.moveTo(screenX, 0);
                    ctx.lineTo(screenX, canvas.height);
                    ctx.stroke();
                }
            }

            for (let y = -gridExtent; y <= gridExtent; y += gridSpacing) {
                const screenY = centerY - y * scale;
                if (screenY >= 0 && screenY <= canvas.height) {
                    ctx.beginPath();
                    ctx.moveTo(0, screenY);
                    ctx.lineTo(canvas.width, screenY);
                    ctx.stroke();
                }
            }

            ctx.strokeStyle = '#9ca3af';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, canvas.height);
            ctx.moveTo(0, centerY);
            ctx.lineTo(canvas.width, centerY);
            ctx.stroke();

            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 4;
            ctx.beginPath();

            const bowLength = length * 0.15;
            const sternLength = length * 0.10;
            const startY = length/2;
            const endY = -length/2;
            const sternCornerRadius = width * 0.15;

            const points = [];

            for (let y = startY; y >= startY - bowLength; y -= 0.3) {
                const localY = startY - y;
                const ratio = localY / bowLength;
                const x = (width/2) * Math.sqrt(Math.abs(2 * ratio - ratio * ratio));
                points.push({
                    x: centerX + x * scale, 
                    y: centerY - y * scale
                });
            }

            points.push({x: centerX + (width/2) * scale, y: centerY - (startY - bowLength) * scale});
            points.push({x: centerX + (width/2) * scale, y: centerY - (endY + sternLength) * scale});

            for (let angle = 0; angle <= 90; angle += 5) {
                const rad = angle * Math.PI / 180;
                const cx = (width/2 - sternCornerRadius);
                const cy = endY + sternCornerRadius;
                const px = cx + sternCornerRadius * Math.cos(rad);
                const py = cy - sternCornerRadius * Math.sin(rad);
                points.push({x: centerX + px * scale, y: centerY - py * scale});
            }

            points.push({x: centerX + (width/2 - sternCornerRadius) * scale, y: centerY - endY * scale});
            points.push({x: centerX - (width/2 - sternCornerRadius) * scale, y: centerY - endY * scale});

            for (let angle = 90; angle <= 180; angle += 5) {
                const rad = angle * Math.PI / 180;
                const cx = -(width/2 - sternCornerRadius);
                const cy = endY + sternCornerRadius;
                const px = cx + sternCornerRadius * Math.cos(rad);
                const py = cy - sternCornerRadius * Math.sin(rad);
                points.push({x: centerX + px * scale, y: centerY - py * scale});
            }

            points.push({x: centerX - (width/2) * scale, y: centerY - (endY + sternLength) * scale});
            points.push({x: centerX - (width/2) * scale, y: centerY - (startY - bowLength) * scale});

            for (let y = startY - bowLength; y <= startY; y += 0.3) {
                const localY = startY - y;
                const ratio = localY / bowLength;
                const x = (width/2) * Math.sqrt(Math.abs(2 * ratio - ratio * ratio));
                points.push({
                    x: centerX - x * scale, 
                    y: centerY - y * scale
                });
            }

            ctx.moveTo(points[0].x, points[0].y);
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            ctx.closePath();
            ctx.stroke();

            const absolutePositions = calculateAbsolutePositions();
            const refSensor = document.getElementById('referenceSelect').value;

            if (refSensor && absolutePositions[refSensor]) {
                const refPos = absolutePositions[refSensor];

                sensors.forEach(sensor => {
                    if (sensor.name && absolutePositions[sensor.name]) {
                        const pos = absolutePositions[sensor.name];
                        const relX = pos.x - refPos.x;
                        const relY = pos.y - refPos.y;

                        const sx = centerX + relX * scale;
                        const sy = centerY - relY * scale;

                        const sensorRadius = 8 * Math.min(zoomLevel, 2);
                        ctx.fillStyle = '#000000';
                        ctx.beginPath();
                        ctx.arc(sx, sy, sensorRadius, 0, 2 * Math.PI);
                        ctx.fill();

                        const fontSize = Math.max(12, 14 * Math.min(zoomLevel, 1.5));
                        ctx.fillStyle = '#000000';
                        ctx.font = `bold ${fontSize}px Arial`;
                        ctx.fillText(sensor.name, sx + sensorRadius + 5, sy - 5);
                    }
                });
            }

            ctx.fillStyle = '#6b7280';
            ctx.font = '14px Arial';
            ctx.fillText('Bow', centerX - 15, centerY - (startY * scale) - 15);
            ctx.fillText('Stern', centerX - 25, centerY - (endY * scale) + 25);
            ctx.fillText('Port', centerX - (width/2 * scale) - 40, centerY);
            ctx.fillText('Starboard', centerX + (width/2 * scale) + 15, centerY);
        }

        const canvas = document.getElementById('vesselCanvas');

        canvas.addEventListener('mousedown', function(e) {
            isPanning = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });

        canvas.addEventListener('mousemove', function(e) {
            if (isPanning) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                panOffsetX += deltaX;
                panOffsetY += deltaY;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                drawVessel();
            }
        });

        canvas.addEventListener('mouseup', function() {
            isPanning = false;
            canvas.style.cursor = 'grab';
        });

        canvas.addEventListener('mouseleave', function() {
            isPanning = false;
            canvas.style.cursor = 'grab';
        });

        canvas.addEventListener('wheel', function(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            zoomLevel *= delta;
            drawVessel();
        });

        canvas.style.cursor = 'grab';

        initializeSensors();
    </script>
</body>
</html>
